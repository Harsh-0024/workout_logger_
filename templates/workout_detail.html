{% extends 'base.html' %}
{% block content %}
<div class="row justify-content-center">
    <div class="col-12 col-md-10 col-lg-8">
        <div class="card">
            <div class="text-center mb-4 mb-md-5">
                <div class="mb-3 mb-md-4">
                    <i class="bi bi-calendar-check" style="font-size: clamp(3rem, 10vw, 4rem); color: var(--gold-primary); opacity: 0.6;"></i>
                </div>
                <h2 class="fw-bold mb-2 mb-md-3" style="font-size: clamp(1.5rem, 6vw, 2rem);">{{ workout_name }}</h2>
                <p class="text-muted mb-0" style="font-size: clamp(0.875rem, 3vw, var(--fs-lg));">{{ date }}</p>
            </div>

            <div class="d-flex justify-content-center flex-wrap gap-2 mb-3 mb-md-4">
                <div class="badge bg-dark d-inline-flex align-items-center" style="font-size: var(--fs-sm); padding: 10px 18px; border: 1px solid var(--border-subtle);">
                    <i class="bi bi-activity me-2 text-gold"></i>{{ exercise_count or 0 }} Exercises
                </div>
                <div class="badge bg-dark d-inline-flex align-items-center" style="font-size: var(--fs-sm); padding: 10px 18px; border: 1px solid var(--border-subtle);">
                    <i class="bi bi-stack me-2 text-gold"></i>{{ set_count or 0 }} Sets
                </div>
            </div>

            {% if missing_bw_exercises %}
            <div class="alert alert-warning mb-4 mb-md-5" role="alert" style="background: var(--gold-subtle); border-color: var(--border-gold); color: var(--text-primary);">
                <i class="bi bi-info-circle me-2"></i>
                Set your bodyweight in Settings to see accurate BW volume and 1RM for: {{ missing_bw_exercises | join(', ') }}.
            </div>
            {% endif %}

            <div class="d-flex justify-content-center gap-2 mb-4 mb-md-5 flex-wrap workout-action-buttons">
                <a href="{{ url_for('edit_workout', date_str=date) }}" class="btn btn-gold-outline btn-sm flex-fill flex-sm-grow-0">
                    <i class="bi bi-pencil-square me-2"></i>Edit Workout
                </a>
                <button type="button" id="shareWorkoutBtn" class="btn btn-gold-solid btn-sm flex-fill flex-sm-grow-0" data-share-url="{{ share_url }}">
                    <i class="bi bi-share-fill me-2"></i>Share Workout
                </button>
            </div>
            <style>
                @media (max-width: 576px) {
                    .workout-action-buttons {
                        flex-direction: row;
                    }
                    .workout-action-buttons .btn {
                        min-width: 0;
                    }
                }
            </style>

            <div class="mb-4 mb-md-5">
                <label class="form-label text-muted mb-2 mb-md-3 d-block tracking-wide" style="font-size: var(--fs-xs); text-transform: uppercase; letter-spacing: 2px; font-weight: 600;">
                    <i class="bi bi-list-check me-2"></i>Exercises
                </label>

                <div class="list-group">
                    {% for log in logs %}
                    <a href="{{ url_for('stats_index') }}?exercise={{ log.exercise | urlencode }}" class="list-group-item bg-dark border-subtle mb-2 text-decoration-none exercise-card-link" style="border-radius: 12px; border-color: var(--border-subtle); cursor: pointer; transition: all var(--transition-base);">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-2 text-white" style="font-size: clamp(0.875rem, 3vw, 1rem);">{{ log.exercise }}</h6>
                                <div class="text-muted" style="font-size: var(--fs-xs);">
                                    {% if log.sets_display %}
                                        <div class="mb-1">Sets: {{ log.sets_display }}</div>
                                    {% elif log.top_weight and log.top_reps %}
                                        <div class="mb-1">Top Set: {{ log.top_weight }}kg Ã— {{ log.top_reps }} reps</div>
                                    {% endif %}
                                    <div class="d-flex gap-3 flex-wrap">
                                        {% if log.estimated_1rm %}
                                            <span>Est. 1RM: {{ "%.1f"|format(log.estimated_1rm) }}kg</span>
                                        {% endif %}
                                        {% if log.total_volume %}
                                            <span>Volume: {{ "%.0f"|format(log.total_volume) }}kg</span>
                                        {% endif %}
                                    </div>
                                    {% if log.exercise in missing_bw_exercises %}
                                        <div class="text-warning mt-2" style="font-size: var(--fs-xs);">
                                            <i class="bi bi-exclamation-circle me-1"></i>Set bodyweight in Settings to see accurate BW metrics.
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <i class="bi bi-chevron-right text-muted align-self-center"></i>
                        </div>
                    </a>
                    {% endfor %}
                </div>

                <div class="mt-4 p-3 border rounded" style="border-color: var(--border-subtle) !important; background: var(--gold-subtle);">
                    <details>
                        <summary class="text-gold fw-semibold" style="cursor: pointer; font-size: var(--fs-sm);">
                            <i class="bi bi-code-square me-2"></i>View Raw Log Data
                        </summary>
                        <textarea class="form-control mt-3" rows="10"
                                  style="font-family: 'SF Mono', 'Menlo', 'Monaco', monospace; font-size: clamp(0.75rem, 2.5vw, 0.875rem); line-height: 1.6; height: clamp(200px, 32vh, 360px);"
                                  readonly>{{ workout_text }}</textarea>
                    </details>
                </div>
            </div>

            <div class="text-center pt-3 pt-md-4 border-top" style="border-color: var(--border-subtle) !important;">
                <a href="/" class="text-muted text-decoration-none small hover-gold tracking-wide">
                    <i class="bi bi-arrow-left me-1"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </div>
</div>
<script>
    (function() {
        const button = document.getElementById('shareWorkoutBtn');
        if (!button) return;
        const url = button.dataset.shareUrl || window.location.href;

        const setStatus = (label, timeout = 2000) => {
            if (!button.dataset.originalLabel) {
                button.dataset.originalLabel = button.innerHTML;
            }
            button.innerHTML = label;
            window.setTimeout(() => {
                button.innerHTML = button.dataset.originalLabel || '<i class="bi bi-share-fill me-2"></i>Share Workout';
            }, timeout);
        };

        const copyFallback = async () => {
            if (navigator.clipboard && window.isSecureContext) {
                await navigator.clipboard.writeText(url);
                setStatus('<i class="bi bi-check-circle-fill me-2"></i>Link Copied');
                return;
            }
            const temp = document.createElement('textarea');
            temp.value = url;
            temp.setAttribute('readonly', 'true');
            temp.style.position = 'absolute';
            temp.style.left = '-9999px';
            document.body.appendChild(temp);
            temp.select();
            document.execCommand('copy');
            document.body.removeChild(temp);
            setStatus('<i class="bi bi-check-circle-fill me-2"></i>Link Copied');
        };

        button.addEventListener('click', async () => {
            await copyFallback();
        });
    })();
</script>
{% endblock %}
